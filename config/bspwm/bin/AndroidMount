#!/bin/sh
# =============================================================
# gh0stzk
# https://github.com/gh0stzk/dotfiles
# 10.07.2024 07:05:25
# Mount and unmount Android device using simple-mtpfs and Rofi
#
# Copyright (C) 2021-2025 gh0stzk <z0mbi3.zk@protonmail.com>
# Licensed under GPL-3.0 license
# =============================================================

set -euo pipefail

BASE_MOUNT_POINT="$HOME/Android_Mount"
ROFI_THEME="$HOME/.config/bspwm/config/rofi-themes/Android.rasi"

# Function to list available MTP devices using Rofi
list_devices() {
    simple-mtpfs -l | awk -F': ' '{print $1 " " $2}' | rofi -dmenu -p "Select device" -theme "$ROFI_THEME"
}

# Function to check if a directory is a mount point
is_mounted() {
    findmnt -rno TARGET "$1" >/dev/null
}

# Function to mount a device
mount_device() {
    local device_num="$1"
    local mount_point="$2"
    mkdir -p "$mount_point"
    if simple-mtpfs --device "$device_num" "$mount_point"; then
        dunstify -i phone -a Android "Android Mount" "Device mounted at $mount_point"
    else
        dunstify -i phone -a Android "Android Mount" "Failed to mount device"
        rmdir "$mount_point" # Clean up created directory if mount fails
    fi
}

# Function to unmount a device
unmount_device() {
    local mount_point="$1"
    if fusermount -u "$mount_point"; then
        dunstify -i phone -a Android "Android Unmount" "Device unmounted from $mount_point"
        rmdir "$mount_point"
    else
        dunstify -i phone -a Android "Android Unmount" "Failed to unmount device"
    fi
}

# Function to open the file manager at the mount point
open_file_manager() {
    local mount_point="$1"
    xdg-open "$mount_point"
}

# Main script logic
main() {
    local device
    device=$(list_devices) || exit 1

    local device_num
    device_num=$(echo "$device" | awk '{print $1}')
    local device_name
    device_name=$(echo "$device" | awk '{$1=""; print $0}' | xargs)
    local sanitized_device_name
    sanitized_device_name=$(echo "$device_name" | tr ' ' '_')
    local mount_point="$BASE_MOUNT_POINT/$sanitized_device_name"

    if [ -z "$device_num" ]; then
        dunstify -i phone -a Android "Android Mount" "No device selected"
        exit 1
    fi

    if is_mounted "$mount_point"; then
        local options="Unmount
Open in File Manager"
        local action
        action=$(echo -e "$options" | rofi -dmenu -p "$device_name is mounted" -theme "$ROFI_THEME")

        case "$action" in
            "Unmount")
                unmount_device "$mount_point"
                ;;
            "Open in File Manager")
                open_file_manager "$mount_point"
                ;;
        esac
    else
        local options="Mount"
        local action
        action=$(echo -e "$options" | rofi -dmenu -p "$device_name is not mounted" -theme "$ROFI_THEME")

        if [ "$action" = "Mount" ]; then
            mount_device "$device_num" "$mount_point"
        fi
    fi
}

main "$@"
