#!/bin/sh
# =============================================================
# Author: gh0stzk
# Repo:   https://github.com/gh0stzk/dotfiles
# Date:   06.04.2025 09:41:28
#
# ArchUpdates - Script to check for new updates in ARCH and AUR
#               and sync updates module in polybar/Eww.
# Features:
#   ✔ Shows the number of updates available in polybar/eww
#   ✔ Used in a pacman hook to update the polybar-module/eww-poll. --sync-polybar
#
# Dependencies:
#   → pacman-contrib, paru, polybar, eww (optional)
#
# Copyright (C) 2021-2025 gh0stzk <z0mbi3.zk@protonmail.com>
# Licensed under GPL-3.0 license
# =============================================================

set -euo pipefail

UPDATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/Updates.txt"

# Function to check for updates and update the count file
check_updates() {
    local official_count=0
    local aur_count=0

    # Get official updates count
    if updates_output=$(checkupdates 2>/dev/null); then
        official_count=$(echo "$updates_output" | wc -l)
    fi

    # Get AUR updates count
    if aur_updates_output=$(paru -Qua 2>/dev/null); then
        aur_count=$(echo "$aur_updates_output" | wc -l)
    fi

    local total_updates=$((official_count + aur_count))
    echo "$total_updates" > "$UPDATE_FILE"

    # Sends the signal to polybar-module/eww-poll to update the data.
    if pgrep -x polybar >/dev/null; then
        polybar-msg action updates hook 0 >/dev/null 2>&1
    elif command -v eww >/dev/null; then # Check if eww is installed
        local current_rice
        # Attempt to read current rice, default to empty if file not found
        if [ -f "$HOME"/.config/bspwm/.rice ]; then
            read -r current_rice < "$HOME"/.config/bspwm/.rice
        else
            current_rice=""
        fi

        if [ -n "$current_rice" ] && [ -d "$HOME/.config/bspwm/rices/${current_rice}/bar" ]; then
            eww -c "$HOME/.config/bspwm/rices/${current_rice}/bar" update updates="$total_updates"
        elif [ -d "$HOME/.config/eww" ]; then # Fallback to default eww config if rice specific not found
            eww -c "$HOME/.config/eww" update updates="$total_updates"
        fi
    fi
}

# Function to list available updates
list_updates() {
    # Ensure update counts are fresh and polybar/eww are signaled
    check_updates

    local total_updates
    total_updates=$(cat "$UPDATE_FILE")

    local official_updates=""
    local aur_updates=""

    # Get actual update lists for display
    if updates_output=$(checkupdates 2>/dev/null); then
        official_updates="$updates_output"
    fi

    if aur_updates_output=$(paru -Qua 2>/dev/null); then
        aur_updates="$aur_updates_output"
    fi

    if [ "$total_updates" -gt 0 ]; then
        printf "\n%sThere are %s updates available:%s\n" "$(tput bold)$(tput setaf 3)" "$total_updates" "$(tput sgr0)"

        if [ -n "$official_updates" ]; then
            printf "\n%sOfficial updates:%s\n" "$(tput bold)$(tput setaf 4)" "$(tput sgr0)"
            echo "$official_updates" | sed 's/->/\x1b[32;1m▶▶\x1b[0m/g'
        fi

        if [ -n "$aur_updates" ]; then
            printf "\n%sAUR updates:%s\n" "$(tput bold)$(tput setaf 4)" "$(tput sgr0)"
            echo "$aur_updates" | sed 's/->/\x1b[32;1m▶▶\x1b[0m/g'
        fi
    else
        printf "\n%s¡Your system is already updated!%s\n" "$(tput bold)$(tput setaf 2)" "$(tput sgr0)"
    fi
    exit 0
}

# Execute it accordingly
case "$1" in
    --sync-polybar)
        check_updates
        ;;
    --print-updates)
        list_updates
        ;;
    *)
        echo "Usage: $(basename "$0") [OPTIONS]"
        echo "  --sync-polybar      Sync data & polybar/eww module"
        echo "  --print-updates     Sync data, polybar/eww module & print available apps to update"
        exit 1
        ;;
esac
